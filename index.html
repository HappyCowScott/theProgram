// Main entry points for GET and POST requests
function doGet(e) {
  console.log('GET request:', e.parameter);
  const action = e.parameter.action || 'getMembers';
  
  try {
    switch (action) {
      case 'getVersion':
        return ContentService.createTextOutput("Version: 4.0 - Image Proxy Ready")
          .setMimeType(ContentService.MimeType.TEXT);
      case 'getWorkouts': 
        return getWorkouts(e.parameter);
      case 'getMembers': 
        return getMembers();
      case 'getMember': 
        return getMember(e.parameter.id);
      case 'getWorkoutDetails': 
        return getWorkoutDetails(e.parameter.workoutId);
      case 'getDashboard':
        return getDashboardData();
      case 'test':
        return ContentService.createTextOutput('SUCCESS: Web App is working!')
          .setMimeType(ContentService.MimeType.TEXT);
      default: 
        return createResponse({ error: 'Unknown GET action: ' + action });
    }
  } catch (error) {
    console.error('GET error:', error);
    return createResponse({ 
      error: error.toString(), 
      stack: error.stack,
      action: action 
    });
  }
}

function doPost(e) {
  console.log('POST request received');
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;
    const data = payload.data;
    
    switch (action) {
      case 'addMember':
        return addMember(data);
      case 'addWorkout':
        return addWorkout(data);
      case 'updateMemberProfilePicture':
        return updateMemberProfilePicture(data);
      case 'updateWorkoutPicture':
        return updateWorkoutPicture(data);
      default:
        return createResponse({ error: 'Unknown POST action: ' + action });
    }
  } catch (error) {
    console.error('POST error:', error);
    return createResponse({ 
      error: error.toString(), 
      stack: error.stack 
    });
  }
}

// --- Data Retrieval Functions ---

function getMembers() {
  const sheet = getOrCreateSheet('Members');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  const scottMetcalf = {
    id: 999,
    firstName: 'Scott',
    lastName: 'Metcalf',
    email: 'scott@theprogram.com',
    phone: '555-0001',
    joinDate: '2024-01-01',
    status: 'Active',
    profilePictureURL: '', // No picture for the virtual member
    notes: 'Program Founder'
  };
  
  const members = [scottMetcalf];
  
  if (data.length > 1) {
    for (let i = 1; i < data.length; i++) {
      if (data[i][0]) {
        if (data[i][1] === 'Scott' && data[i][2] === 'Metcalf') continue;
        
        const member = {};
        for (let j = 0; j < headers.length; j++) {
          member[headers[j]] = data[i][j];
        }
        
        // Convert FileId to a Data URL for the app to use
        member.profilePictureURL = getImageDataUrl(member.profilePictureFileId);
        delete member.profilePictureFileId; // Clean up the object
        
        members.push(member);
      }
    }
  }
  
  return createResponse({ members: members });
}

function getMember(memberId) {
  if (memberId == 999) {
    const scott = { id: 999, firstName: 'Scott', lastName: 'Metcalf', email: 'scott@theprogram.com', phone: '555-0001', joinDate: '2024-01-01', status: 'Active', profilePictureURL: '', notes: 'Program Founder' };
    const stats = calculateMemberStats(999, 'Scott Metcalf');
    return createResponse({ member: scott, stats: stats });
  }
  
  const sheet = getOrCreateSheet('Members');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == memberId) {
      const member = {};
      for (let j = 0; j < headers.length; j++) {
        member[headers[j]] = data[i][j];
      }
      
      member.profilePictureURL = getImageDataUrl(member.profilePictureFileId);
      delete member.profilePictureFileId;
      
      const stats = calculateMemberStats(memberId, member.firstName + ' ' + member.lastName);
      return createResponse({ member: member, stats: stats });
    }
  }
  
  return createResponse({ error: 'Member not found' });
}

function getWorkouts(params) {
  const sheet = getOrCreateSheet('Workouts');
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) return createResponse({ workouts: [] });
  
  const headers = data[0];
  const workouts = [];
  const membersMap = getMembersMap();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      const workout = {};
      for (let j = 0; j < headers.length; j++) {
        workout[headers[j]] = data[i][j];
      }
      
      workout.workoutPictureURL = getImageDataUrl(workout.workoutPictureFileId);
      delete workout.workoutPictureFileId;
      
      if (!workout.type) workout.type = 'General';
      const trainer = membersMap[workout.trainerId];
      workout.trainer = trainer ? `${trainer.firstName} ${trainer.lastName}` : 'Unknown';
      const participantIds = workout.participantIds ? workout.participantIds.toString().split(',') : [];
      workout.participants = participantIds.map(id => {
          const member = membersMap[id.trim()];
          return member ? `${member.firstName} ${member.lastName}` : null;
        }).filter(name => name !== null);
      workout.participantCount = workout.participants.length;
      workouts.push(workout);
    }
  }
  
  workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
  return createResponse({ workouts: workouts });
}

function getWorkoutDetails(workoutId) {
  const sheet = getOrCreateSheet('Workouts');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == workoutId) {
      const workout = {};
      for (let j = 0; j < headers.length; j++) {
        workout[headers[j]] = data[i][j];
      }
      
      if (workout.details) {
        try {
          workout.details = JSON.parse(workout.details);
        } catch (e) {
          workout.details = {};
        }
      }
      
      return createResponse({ details: workout });
    }
  }
  
  return createResponse({ error: 'Workout not found' });
}

function getDashboardData() {
  const workouts = JSON.parse(getWorkouts({}).getContent()).workouts;
  const members = JSON.parse(getMembers().getContent()).members;
  
  return createResponse({
    recentWorkouts: workouts.slice(0, 10),
    totalMembers: members.length,
    activeMembers: members.filter(m => m.status === 'Active').length,
    totalWorkouts: workouts.length
  });
}

// --- Data Modification Functions ---

function addMember(data) {
  const sheet = getOrCreateSheet('Members');
  const newId = getNextId(sheet);
  
  const newRow = [
    newId,
    data.firstName || '',
    data.lastName || '',
    data.email || '',
    data.phone || '',
    data.joinDate || new Date().toISOString().split('T')[0],
    data.status || 'Active',
    '', // profilePictureFileId - will be updated if picture is uploaded
    data.notes || ''
  ];
  
  sheet.appendRow(newRow);
  
  return createResponse({ 
    success: true, 
    memberId: newId,
    message: 'Member added successfully'
  });
}

function addWorkout(data) {
  const sheet = getOrCreateSheet('Workouts');
  const newId = getNextId(sheet);
  
  const newRow = [
    newId,
    data.date || new Date().toISOString().split('T')[0],
    data.trainerId || '',
    data.type || 'General',
    data.location || 'LCHS',
    data.participantIds ? data.participantIds.join(',') : '',
    '', // workoutPictureFileId - will be updated if picture is uploaded
    data.notes || '',
    data.time || '06:00',
    JSON.stringify(data.details || {})
  ];
  
  sheet.appendRow(newRow);
  
  return createResponse({ 
    success: true, 
    workoutId: newId,
    message: 'Workout added successfully'
  });
}

function updateMemberProfilePicture(data) {
  try {
    const imageFolder = getOrCreatePublicImageFolder();
    const imageBlob = Utilities.newBlob(Utilities.base64Decode(data.imageData.split(',')[1]), 'image/jpeg', `member_${data.memberId}.jpg`);
    const file = imageFolder.createFile(imageBlob);
    const fileId = file.getId();

    const sheet = getOrCreateSheet('Members');
    const data_sheet = sheet.getDataRange().getValues();

    for (let i = 1; i < data_sheet.length; i++) {
      if (data_sheet[i][0] == data.memberId) {
        sheet.getRange(i + 1, 8).setValue(fileId); // Column H for profilePictureFileId
        break;
      }
    }

    return createResponse({
      success: true,
      fileId: fileId,
      message: 'Profile picture updated successfully'
    });
  } catch (error) {
    return createResponse({
      success: false,
      error: error.toString()
    });
  }
}

function updateWorkoutPicture(data) {
  try {
    const imageFolder = getOrCreatePublicImageFolder();
    const imageBlob = Utilities.newBlob(Utilities.base64Decode(data.imageData.split(',')[1]), 'image/jpeg', `workout_${data.workoutId}.jpg`);
    const file = imageFolder.createFile(imageBlob);
    const fileId = file.getId();

    const sheet = getOrCreateSheet('Workouts');
    const data_sheet = sheet.getDataRange().getValues();

    for (let i = 1; i < data_sheet.length; i++) {
      if (data_sheet[i][0] == data.workoutId) {
        sheet.getRange(i + 1, 7).setValue(fileId); // Column G for workoutPictureFileId
        break;
      }
    }

    return createResponse({
      success: true,
      fileId: fileId,
      message: 'Workout picture updated successfully'
    });
  } catch (error) {
    return createResponse({
      success: false,
      error: error.toString()
    });
  }
}

// --- Helper Functions ---

function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function calculateMemberStats(memberId, memberName) {
  const workoutsSheet = getOrCreateSheet('Workouts');
  const data = workoutsSheet.getDataRange().getValues();
  
  let asTrainer = 0;
  let asParticipant = 0;
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == memberId) {
      asTrainer++;
    }
    
    const participants = data[i][5] ? data[i][5].toString().split(',') : [];
    if (participants.includes(memberId.toString())) {
      asParticipant++;
    }
  }
  
  return {
    asTrainer: asTrainer,
    asParticipant: asParticipant,
    totalWorkouts: asTrainer + asParticipant
  };
}

function getOrCreateSheet(sheetName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    
    if (sheetName === 'Members') {
      sheet.getRange(1, 1, 1, 9).setValues([[
        'id', 'firstName', 'lastName', 'email', 'phone', 
        'joinDate', 'status', 'profilePictureFileId', 'notes'
      ]]);
    } else if (sheetName === 'Workouts') {
      sheet.getRange(1, 1, 1, 10).setValues([[
        'id', 'date', 'trainerId', 'type', 'location', 
        'participantIds', 'workoutPictureFileId', 'notes', 'time', 'details'
      ]]);
    }
  }
  
  return sheet;
}

function getNextId(sheet) {
  const data = sheet.getDataRange().getValues();
  let maxId = 0;
  
  for (let i = 1; i < data.length; i++) {
    const id = parseInt(data[i][0]);
    if (!isNaN(id) && id > maxId) {
      maxId = id;
    }
  }
  
  return maxId + 1;
}

function getMembersMap() {
  const sheet = getOrCreateSheet('Members');
  const data = sheet.getDataRange().getValues();
  const map = {};
  
  map[999] = { id: 999, firstName: 'Scott', lastName: 'Metcalf', status: 'Active' };
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      map[data[i][0]] = {
        id: data[i][0],
        firstName: data[i][1],
        lastName: data[i][2],
        status: data[i][6]
      };
    }
  }
  
  return map;
}

function getOrCreatePublicImageFolder() {
  const folderName = "WorkoutApp_Images";
  const folders = DriveApp.getFoldersByName(folderName);
  
  let folder;
  if (folders.hasNext()) {
    folder = folders.next();
  } else {
    folder = DriveApp.createFolder(folderName);
    folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  }
  return folder;
}

function getImageDataUrl(fileId) {
  if (!fileId) {
    return "";
  }
  try {
    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    const contentType = blob.getContentType();
    const base64Data = Utilities.base64Encode(blob.getBytes());
    return `data:${contentType};base64,${base64Data}`;
  } catch (e) {
    console.error("getImageDataUrl Error: " + e.toString());
    return "";
  }
}

// --- Spreadsheet UI and Setup Functions ---

function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('Admin')
      .addItem('⚠️ Reset All Sheets', 'resetSheets')
      .addToUi();
}

function resetSheets() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'Confirm Reset',
    'Are you sure you want to delete all data in the "Members" and "Workouts" sheets? This action cannot be undone.',
    ui.ButtonSet.YES_NO
  );

  if (response == ui.Button.YES) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetsToReset = ['Members', 'Workouts'];
    
    sheetsToReset.forEach(sheetName => {
      const sheet = ss.getSheetByName(sheetName);
      if (sheet) {
        ss.deleteSheet(sheet);
      }
    });
    
    getOrCreateSheet('Members');
    getOrCreateSheet('Workouts');
    
    ui.alert('Sheets have been successfully reset with the correct headers.');
  } else {
    ui.alert('Reset cancelled.');
  }
}
